<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n de Clientes - Chocolates ByB</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root { 
            --chocolate: #6B4423; 
            --chocolate-dark: #4A2C17; 
            --crema: #FFF8E7; 
            --dorado: #D4AF37; 
            --verde: #28a745; 
            --rojo: #dc3545; 
            --azul: #007bff;
            --gris-claro: #f8f9fa;
            --sombra: 0 4px 6px rgba(0,0,0,0.1);
        }
        body { 
            font-family: 'Arial', sans-serif; 
            background: #f4f4f4; 
            color: #333; 
        }
        .admin-layout { display: flex; min-height: 100vh; }
        .sidebar { 
            width: 250px; 
            background: var(--chocolate-dark); 
            color: white; 
            padding: 20px 0; 
        }
        .sidebar h2 { 
            color: var(--dorado); 
            padding: 0 20px 20px; 
            border-bottom: 1px solid rgba(255,255,255,0.1); 
        }
        .sidebar-menu { list-style: none; margin-top: 20px; }
        .sidebar-menu a { 
            display: block; 
            color: white; 
            text-decoration: none; 
            padding: 15px 20px; 
            transition: background 0.3s; 
        }
        .sidebar-menu a:hover, .sidebar-menu a.active { 
            background: var(--chocolate); 
            border-left: 3px solid var(--dorado); 
        }
        .main-content { 
            flex: 1; 
            padding: 20px; 
            margin-left: 250px;
        }
        .header { 
            background: white; 
            padding: 20px; 
            border-radius: 10px; 
            box-shadow: var(--sombra);
            margin-bottom: 20px; 
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .btn { 
            padding: 10px 15px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            text-decoration: none;
            font-weight: bold;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
        }
        .btn-sm {
            padding: 6px 10px;
            font-size: 0.9rem;
        }
        .btn-primary { background: var(--azul); color: white; }
        .btn-success { background: var(--verde); color: white; }
        .btn-warning { background: var(--dorado); color: white; }
        .btn-danger { background: var(--rojo); color: white; }
        
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: var(--sombra);
            margin-bottom: 20px;
            overflow: hidden;
        }
        .card-header {
            background: var(--chocolate);
            color: white;
            padding: 15px 20px;
            font-weight: bold;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .card-body {
            padding: 20px;
        }
        
        .search-box {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: var(--sombra);
            display: flex;
            align-items: center;
        }
        .search-input {
            flex: 1;
            padding: 10px 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
        }
        .search-btn {
            padding: 10px 15px;
            background: var(--chocolate);
            color: white;
            border: none;
            border-radius: 5px;
            margin-left: 10px;
            cursor: pointer;
        }
        
        .table-responsive {
            overflow-x: auto;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            background: var(--gris-claro);
            font-weight: bold;
        }
        tr:hover {
            background: var(--crema);
        }
        
        .customer-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }
        .badge-vip {
            background-color: #FFD700;
            color: #333;
        }
        .badge-frequent {
            background-color: var(--verde);
            color: white;
        }
        .badge-regular {
            background-color: var(--azul);
            color: white;
        }
        .badge-inactive {
            background-color: #6c757d;
            color: white;
        }
        
        .customer-card {
            background: white;
            border-radius: 10px;
            box-shadow: var(--sombra);
            margin-bottom: 20px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        .customer-header {
            background: var(--chocolate);
            color: white;
            padding: 15px;
            position: relative;
        }
        .customer-badge-corner {
            position: absolute;
            top: 0;
            right: 0;
            padding: 5px 10px;
            font-size: 0.8rem;
            font-weight: bold;
            border-bottom-left-radius: 10px;
        }
        .customer-body {
            padding: 15px;
            flex: 1;
        }
        .customer-info {
            margin-bottom: 10px;
        }
        .customer-info label {
            font-size: 0.9rem;
            color: #666;
            display: block;
            margin-bottom: 3px;
        }
        .customer-info p {
            margin: 0;
            font-weight: bold;
        }
        .customer-stats {
            display: flex;
            justify-content: space-between;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #eee;
        }
        .stat-item {
            text-align: center;
        }
        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--chocolate);
        }
        .stat-label {
            font-size: 0.8rem;
            color: #666;
        }
        .customer-actions {
            padding: 10px 15px;
            background: var(--gris-claro);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .tabs {
            display: flex;
            margin-bottom: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: var(--sombra);
            overflow: hidden;
        }
        .tab {
            padding: 15px 20px;
            cursor: pointer;
            transition: all 0.3s;
            flex: 1;
            text-align: center;
            font-weight: bold;
            color: #666;
        }
        .tab.active {
            background: var(--chocolate);
            color: white;
        }
        .tab-content {
            display: none;
        }
        .tab-content.active {
            display: block;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            border-radius: 10px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        .modal-header {
            background: var(--chocolate);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .modal-header h3 {
            margin: 0;
        }
        .modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
        .modal-body {
            padding: 20px;
        }
        .modal-footer {
            padding: 15px 20px;
            background: var(--gris-claro);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--chocolate);
        }
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .customer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        @media (max-width: 768px) {
            .sidebar {
                display: none;
            }
            .main-content {
                margin-left: 0;
            }
            .customer-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="admin-layout">
        <aside class="sidebar">
            <h2>üç´ Admin Panel</h2>
            <ul class="sidebar-menu">
                <li><a href="/admin">üìä Dashboard</a></li>
                <li><a href="/admin/pedidos">üì¶ Pedidos</a></li>
                <li><a href="/admin/productos">üç´ Productos</a></li>
                <li><a href="/admin/zonas">üìç Zonas de Entrega</a></li>
                <li><a href="/admin/financiero">üí∞ Financiero</a></li>
                <li><a href="/admin/inventario">üì¶ Inventario</a></li>
                <li><a href="/admin/clientes" class="active">üë• Clientes</a></li>
                <li><a href="/admin/recetas">üìù Recetas</a></li>
                <li><a href="/" target="_blank">üåê Ver Tienda</a></li>
                <li><a href="/logout">üö™ Salir</a></li>
            </ul>
        </aside>

        <main class="main-content">
            <div class="header">
                <h1>Gesti√≥n de Clientes</h1>
                <div>
                    <button class="btn btn-primary" onclick="mostrarModal('modalNuevoCliente')">
                        <i class="fas fa-user-plus"></i> Nuevo Cliente
                    </button>
                    <button class="btn btn-success" onclick="exportarClientes()">
                        <i class="fas fa-file-export"></i> Exportar
                    </button>
                </div>
            </div>

            <!-- Buscador -->
            <div class="search-box">
                <input type="text" class="search-input" placeholder="Buscar cliente por nombre o tel√©fono..." id="searchInput">
                <button class="search-btn" onclick="buscarClientes()">
                    <i class="fas fa-search"></i> Buscar
                </button>
            </div>

            <!-- Tabs de Navegaci√≥n -->
            <div class="tabs">
                <div class="tab active" onclick="cambiarTab('frecuentes')">
                    <i class="fas fa-star"></i> Clientes Frecuentes
                </div>
                <div class="tab" onclick="cambiarTab('todos')">
                    <i class="fas fa-users"></i> Todos los Clientes
                </div>
                <div class="tab" onclick="cambiarTab('inactivos')">
                    <i class="fas fa-user-clock"></i> Clientes Inactivos
                </div>
            </div>

            <!-- Tab de Clientes Frecuentes -->
            <div id="tab-frecuentes" class="tab-content active">
                <div class="customer-grid">
                    {% for cliente in clientes_frecuentes %}
                    <div class="customer-card">
                        <div class="customer-header">
                            <h3>{{ cliente.nombre }}</h3>
                            <div class="customer-badge-corner badge-vip">VIP</div>
                        </div>
                        <div class="customer-body">
                            <div class="customer-info">
                                <label><i class="fas fa-phone"></i> Tel√©fono:</label>
                                <p>{{ cliente.telefono }}</p>
                            </div>
                            <div class="customer-info">
                                <label><i class="fas fa-map-marker-alt"></i> Direcci√≥n:</label>
                                <p>{{ cliente.direccion_calle }}</p>
                                <p>{{ cliente.reparto }}, {{ cliente.municipio }}</p>
                            </div>
                            <div class="customer-stats">
                                <div class="stat-item">
                                    <div class="stat-value">{{ cliente.pedidos_completados }}</div>
                                    <div class="stat-label">Pedidos</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">{{ "%.0f"|format(cliente.total_gastado) }}</div>
                                    <div class="stat-label">CUP</div>
                                </div>
                                <div class="stat-item">
                                    <div class="stat-value">{{ cliente.ultimo_pedido.strftime('%d/%m') }}</div>
                                    <div class="stat-label">√öltimo</div>
                                </div>
                            </div>
                        </div>
                        <div class="customer-actions">
                            <button class="btn btn-sm btn-primary" onclick="verCliente({{ cliente.id }})">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="enviarOferta({{ cliente.id }})">
                                <i class="fas fa-gift"></i>
                            </button>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>

            <!-- Tab de Todos los Clientes -->
            <div id="tab-todos" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <span>Listado Completo de Clientes</span>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Tel√©fono</th>
                                        <th>Ubicaci√≥n</th>
                                        <th>Pedidos</th>
                                        <th>Total Gastado</th>
                                        <th>√öltimo Pedido</th>
                                        <th>Estado</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody id="clientesTableBody">
                                    {% for cliente in clientes_todos %}
                                    <tr>
                                        <td>{{ cliente.nombre }}</td>
                                        <td>{{ cliente.telefono }}</td>
                                        <td>{{ cliente.reparto }}, {{ cliente.municipio }}</td>
                                        <td>{{ cliente.pedidos_completados }}</td>
                                        <td>{{ "%.0f"|format(cliente.total_gastado) }} CUP</td>
                                        <td>{{ cliente.ultimo_pedido.strftime('%d/%m/%Y') }}</td>
                                        <td>
                                            {% if cliente.pedidos_completados >= 5 %}
                                                <span class="customer-badge badge-vip">VIP</span>
                                            {% elif cliente.pedidos_completados >= 3 %}
                                                <span class="customer-badge badge-frequent">Frecuente</span>
                                            {% elif cliente.ultimo_pedido < (now - timedelta(days=60)) %}
                                                <span class="customer-badge badge-inactive">Inactivo</span>
                                            {% else %}
                                                <span class="customer-badge badge-regular">Regular</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <button class="btn btn-sm btn-primary" onclick="verCliente({{ cliente.id }})">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab de Clientes Inactivos -->
            <div id="tab-inactivos" class="tab-content">
                <div class="card">
                    <div class="card-header">
                        <span>Clientes Inactivos (sin compras en los √∫ltimos 2 meses)</span>
                        <button class="btn btn-sm btn-warning" onclick="campanaReactivacion()">
                            <i class="fas fa-bullhorn"></i> Campa√±a de Reactivaci√≥n
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nombre</th>
                                        <th>Tel√©fono</th>
                                        <th>√öltimo Pedido</th>
                                        <th>D√≠as Inactivo</th>
                                        <th>Total Hist√≥rico</th>
                                        <th>Acciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for cliente in clientes_inactivos %}
                                    {% set dias_inactivo = (now - cliente.ultimo_pedido).days %}
                                    <tr>
                                        <td>{{ cliente.nombre }}</td>
                                        <td>{{ cliente.telefono }}</td>
                                        <td>{{ cliente.ultimo_pedido.strftime('%d/%m/%Y') }}</td>
                                        <td>{{ dias_inactivo }}</td>
                                        <td>{{ "%.0f"|format(cliente.total_gastado) }} CUP</td>
                                        <td>
                                            <button class="btn btn-sm btn-primary" onclick="verCliente({{ cliente.id }})">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-sm btn-warning" onclick="enviarOferta({{ cliente.id }})">
                                                <i class="fas fa-gift"></i>
                                            </button>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
        </main>
    </div>

    <!-- Modal Nuevo Cliente -->
    <div id="modalNuevoCliente" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Nuevo Cliente</h3>
                <button class="modal-close" onclick="cerrarModal('modalNuevoCliente')">&times;</button>
            </div>
            <div class="modal-body">
                <!-- Aproximadamente l√≠nea 220-280: Actualizar el formulario de nuevo cliente -->
<form id="formNuevoCliente" action="/admin/cliente/nuevo" method="POST">
    <div class="form-group">
        <label>Nombre Completo:</label>
        <input type="text" id="cliente_nombre" name="cliente_nombre" required>
    </div>
    <div class="form-group">
        <label>Tel√©fono:</label>
        <input type="tel" id="cliente_telefono" name="cliente_telefono" required>
    </div>
    <div class="form-group">
        <label>Email (Opcional):</label>
        <input type="email" id="cliente_email" name="cliente_email">
    </div>
    <div class="form-group">
        <label>Direcci√≥n:</label>
        <input type="text" id="cliente_direccion" name="cliente_direccion" required>
    </div>
    <div class="form-group">
        <label>Municipio:</label>
        <select id="cliente_municipio" name="cliente_municipio" required onchange="cargarRepartos()">
            <option value="">Seleccione municipio</option>
            <option value="Guanabacoa">Guanabacoa</option>
            <option value="San Miguel">San Miguel</option>
            <option value="Marianao">Marianao</option>
            <option value="Playa">Playa</option>
            <option value="La Lisa">La Lisa</option>
            <option value="Plaza">Plaza</option>
            <option value="Centro Habana">Centro Habana</option>
            <option value="Habana Vieja">Habana Vieja</option>
            <option value="Boyeros">Boyeros</option>
            <option value="Cerro">Cerro</option>
            <option value="10 de Octubre">10 de Octubre</option>
            <option value="Arroyo Naranjo">Arroyo Naranjo</option>
        </select>
    </div>
    <div class="form-group">
        <label>Reparto:</label>
        <select id="cliente_reparto" name="cliente_reparto" required>
            <option value="">Primero seleccione un municipio</option>
        </select>
    </div>
    <div class="form-group">
        <label>Notas:</label>
        <textarea id="cliente_notas" name="cliente_notas" rows="3"></textarea>
    </div>
    <button type="submit" class="btn btn-primary" style="width: 100%;">Guardar Cliente</button>
</form>
            </div>
        </div>
    </div>

    <!-- Modal Ver Cliente -->
    <div id="modalVerCliente" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalClienteTitulo">Detalles del Cliente</h3>
                <button class="modal-close" onclick="cerrarModal('modalVerCliente')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Nombre:</label>
                    <p id="detalleNombre" class="form-control"></p>
                </div>
                <div class="form-group">
                    <label>Tel√©fono:</label>
                    <p id="detalleTelefono" class="form-control"></p>
                </div>
                <div class="form-group">
                    <label>Email:</label>
                    <p id="detalleEmail" class="form-control"></p>
                </div>
                <div class="form-group">
                    <label>Direcci√≥n:</label>
                    <p id="detalleDireccion" class="form-control"></p>
                </div>
                <div class="form-group">
                    <label>Historial de Pedidos:</label>
                    <div id="detalleHistorial" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
                        <!-- Historial de pedidos -->
                    </div>
                </div>
                <div class="form-group">
                    <label>Estad√≠sticas:</label>
                    <div style="display: flex; justify-content: space-between; margin-top: 10px;">
                        <div style="text-align: center; flex: 1;">
                            <strong style="font-size: 1.5rem; color: var(--chocolate);" id="detalleTotalPedidos">0</strong>
                            <p>Pedidos</p>
                        </div>
                        <div style="text-align: center; flex: 1;">
                            <strong style="font-size: 1.5rem; color: var(--chocolate);" id="detalleTotalGastado">0</strong>
                            <p>CUP Total</p>
                        </div>
                        <div style="text-align: center; flex: 1;">
                            <strong style="font-size: 1.5rem; color: var(--chocolate);" id="detallePromedioCompra">0</strong>
                            <p>Promedio</p>
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    <label>Notas:</label>
                    <textarea id="detalleNotas" rows="3" class="form-control"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-warning" onclick="editarCliente()">
                    <i class="fas fa-edit"></i> Editar
                </button>
                <button class="btn btn-danger" onclick="confirmarEliminar()">
                    <i class="fas fa-trash-alt"></i> Eliminar
                </button>
                <button class="btn btn-primary" onclick="cerrarModal('modalVerCliente')">
                    <i class="fas fa-times"></i> Cerrar
                </button>
            </div>
        </div>
    </div>

    <!-- Modal Enviar Oferta -->
    <div id="modalOferta" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Enviar Oferta Especial</h3>
                <button class="modal-close" onclick="cerrarModal('modalOferta')">&times;</button>
            </div>
            <div class="modal-body">
                <form id="formOferta" onsubmit="enviarOfertaWhatsapp(event)">
                    <input type="hidden" id="oferta_cliente_id">
                    <div class="form-group">
                        <label>Cliente:</label>
                        <input type="text" id="oferta_cliente_nombre" readonly>
                    </div>
                    <div class="form-group">
                        <label>Tel√©fono:</label>
                        <input type="text" id="oferta_cliente_telefono" readonly>
                    </div>
                    <div class="form-group">
                        <label>Tipo de Oferta:</label>
                        <select id="oferta_tipo" required onchange="actualizarDescuento()">
                            <option value="">Seleccione tipo de oferta</option>
                            <option value="descuento">Descuento en Productos</option>
                            <option value="envio">Env√≠o Gratis</option>
                            <option value="combo">Combo Especial</option>
                            <option value="personalizada">Oferta Personalizada</option>
                        </select>
                    </div>
                    <div id="campoDescuento" class="form-group" style="display: none;">
                        <label>Descuento (%):</label>
                        <input type="number" id="oferta_descuento" min="5" max="50" value="10">
                    </div>
                    <div class="form-group">
                        <label>Fecha de Expiraci√≥n:</label>
                        <input type="date" id="oferta_expiracion" required>
                    </div>
                    <div class="form-group">
                        <label>Mensaje Personalizado:</label>
                        <textarea id="oferta_mensaje" rows="5" required placeholder="Ej: Estimado cliente, queremos ofrecerle una promoci√≥n especial por su lealtad..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary" style="width: 100%;">
                        <i class="fab fa-whatsapp"></i> Enviar por WhatsApp
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Campa√±a de Reactivaci√≥n -->
    <div id="modalCampana" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Campa√±a de Reactivaci√≥n</h3>
                <button class="modal-close" onclick="cerrarModal('modalCampana')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Seleccionar Clientes Inactivos por:</label>
                    <select id="campana_filtro" onchange="filtrarClientesCampana()">
                        <option value="todos">Todos los inactivos</option>
                        <option value="60">Inactivos por 60-90 d√≠as</option>
                        <option value="90">Inactivos por m√°s de 90 d√≠as</option>
                        <option value="gastado">Que han gastado m√°s de 3000 CUP</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Clientes Seleccionados: <span id="campana_total">0</span></label>
                    <div id="campana_clientes" style="max-height: 200px; overflow-y: auto; border: 1px solid #ddd; padding: 10px; border-radius: 5px;">
                        <!-- Lista de clientes seleccionados -->
                    </div>
                </div>
                <div class="form-group">
                    <label>Tipo de Oferta:</label>
                    <select id="campana_tipo" required>
                        <option value="descuento">10% de descuento en pr√≥xima compra</option>
                        <option value="envio">Env√≠o gratis en pr√≥xima compra</option>
                        <option value="combo">Combo especial a precio reducido</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Mensaje de la Campa√±a:</label>
                    <textarea id="campana_mensaje" rows="5" required>¬°Hola! Te extra√±amos en Chocolates ByB. Queremos invitarte a disfrutar nuevamente de nuestros deliciosos chocolates artesanales con esta oferta especial. ¬°Esperamos verte pronto!</textarea>
                </div>
                <button class="btn btn-primary" style="width: 100%;" onclick="ejecutarCampana()">
                    <i class="fas fa-paper-plane"></i> Ejecutar Campa√±a
                </button>
            </div>
        </div>
    </div>

    <script>
        // Cambiar entre tabs
        function cambiarTab(tab) {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelectorAll('.tab').forEach(tabElement => {
                tabElement.classList.remove('active');
            });
            
            document.getElementById(`tab-${tab}`).classList.add('active');
            event.currentTarget.classList.add('active');
        }
        
        // Mostrar/ocultar modales
        function mostrarModal(modalId) {
            document.getElementById(modalId).style.display = 'flex';
            
            // Si es el modal de oferta, establecer fecha de expiraci√≥n por defecto (30 d√≠as)
            if (modalId === 'modalOferta') {
                const fecha = new Date();
                fecha.setDate(fecha.getDate() + 30);
                document.getElementById('oferta_expiracion').value = fecha.toISOString().split('T')[0];
            }
        }
        
        function cerrarModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }
        
        // Cargar repartos seg√∫n municipio seleccionado
        async function cargarRepartos() {
            const municipio = document.getElementById('cliente_municipio').value;
            const repartoSelect = document.getElementById('cliente_reparto');
            
            if (!municipio) {
                repartoSelect.innerHTML = '<option value="">Primero seleccione un municipio</option>';
                return;
            }
            
            try {
                const response = await fetch(`/api/zonas/${municipio}`);
                const zonas = await response.json();
                
                repartoSelect.innerHTML = '<option value="">Seleccione reparto</option>';
                
                zonas.forEach(zona => {
                    const option = document.createElement('option');
                    option.value = zona.reparto;
                    option.textContent = zona.reparto;
                    repartoSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Error cargando repartos:', error);
            }
        }
        
        // Funciones para gestionar clientes
        function buscarClientes() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const rows = document.querySelectorAll('#clientesTableBody tr');
            
            rows.forEach(row => {
                const nombre = row.cells[0].textContent.toLowerCase();
                const telefono = row.cells[1].textContent.toLowerCase();
                
                if (nombre.includes(searchTerm) || telefono.includes(searchTerm)) {
                    row.style.display = '';
                } else {
                    row.style.display = 'none';
                }
            });
        }
        
        function verCliente(id) {
            // Aqu√≠ se implementar√≠a la l√≥gica para cargar los datos del cliente desde el servidor
            // Por ahora, simulamos datos de ejemplo
            const cliente = {
                id: id,
                nombre: 'Cliente #' + id,
                telefono: '+53 5' + Math.floor(1000000 + Math.random() * 9000000),
                email: 'cliente' + id + '@example.com',
                direccion: 'Calle Principal #123, entre A y B',
                municipio: 'Playa',
                reparto: 'Miramar',
                pedidos: [
                    { fecha: '2024-05-15', total: 2500, productos: '2x Chocolate Grande, 1x Chocolate Mediano' },
                    { fecha: '2024-04-02', total: 1800, productos: '1x Chocolate Grande, 2x Chocolate Vulva' }
                ],
                total_pedidos: 2,
                total_gastado: 4300,
                notas: 'Cliente frecuente que prefiere chocolate blanco.'
            };
            
            // Llenar el modal con los datos
            document.getElementById('modalClienteTitulo').textContent = cliente.nombre;
            document.getElementById('detalleNombre').textContent = cliente.nombre;
            document.getElementById('detalleTelefono').textContent = cliente.telefono;
            document.getElementById('detalleEmail').textContent = cliente.email || 'No disponible';
            document.getElementById('detalleDireccion').textContent = `${cliente.direccion}, ${cliente.reparto}, ${cliente.municipio}`;
            
            // Historial de pedidos
            const historialDiv = document.getElementById('detalleHistorial');
            historialDiv.innerHTML = '';
            
            cliente.pedidos.forEach(pedido => {
                const pedidoDiv = document.createElement('div');
                pedidoDiv.style.padding = '10px';
                pedidoDiv.style.borderBottom = '1px solid #eee';
                
                pedidoDiv.innerHTML = `
                    <p><strong>Fecha:</strong> ${pedido.fecha}</p>
                    <p><strong>Productos:</strong> ${pedido.productos}</p>
                    <p><strong>Total:</strong> ${pedido.total} CUP</p>
                `;
                
                historialDiv.appendChild(pedidoDiv);
            });
            
            // Estad√≠sticas
            document.getElementById('detalleTotalPedidos').textContent = cliente.total_pedidos;
            document.getElementById('detalleTotalGastado').textContent = cliente.total_gastado;
            document.getElementById('detallePromedioCompra').textContent = Math.round(cliente.total_gastado / cliente.total_pedidos);
            
            // Notas
            document.getElementById('detalleNotas').value = cliente.notas || '';
            
            // Mostrar modal
            mostrarModal('modalVerCliente');
        }
        
        function guardarCliente(event) {
            event.preventDefault();
            
            // Aqu√≠ se implementar√≠a la l√≥gica para guardar el cliente en el servidor
            alert('Cliente guardado exitosamente');
            cerrarModal('modalNuevoCliente');
            
            // En una implementaci√≥n real, se recargar√≠a la lista de clientes
            // location.reload();
        }
        
        function editarCliente() {
            // Aqu√≠ se implementar√≠a la l√≥gica para editar el cliente
            alert('Funci√≥n de edici√≥n de cliente');
        }
        
        function confirmarEliminar() {
            if (confirm('¬øEst√° seguro de que desea eliminar este cliente? Esta acci√≥n no se puede deshacer.')) {
                // Aqu√≠ se implementar√≠a la l√≥gica para eliminar el cliente
                alert('Cliente eliminado exitosamente');
                cerrarModal('modalVerCliente');
            }
        }
        
        function exportarClientes() {
            // Aqu√≠ se implementar√≠a la l√≥gica para exportar la lista de clientes
            alert('Exportando lista de clientes...');
            // window.location.href = '/admin/exportar-clientes';
        }
        
        // Funciones para ofertas y campa√±as
        function enviarOferta(id) {
            // Simulamos datos de cliente
            const cliente = {
                id: id,
                nombre: 'Cliente #' + id,
                telefono: '+53 5' + Math.floor(1000000 + Math.random() * 9000000)
            };
            
            // Llenar el modal
            document.getElementById('oferta_cliente_id').value = cliente.id;
            document.getElementById('oferta_cliente_nombre').value = cliente.nombre;
            document.getElementById('oferta_cliente_telefono').value = cliente.telefono;
            
            // Mostrar modal
            mostrarModal('modalOferta');
        }
        
        function actualizarDescuento() {
            const tipoOferta = document.getElementById('oferta_tipo').value;
            const campoDescuento = document.getElementById('campoDescuento');
            
            if (tipoOferta === 'descuento') {
                campoDescuento.style.display = 'block';
            } else {
                campoDescuento.style.display = 'none';
            }
        }
        
        function enviarOfertaWhatsapp(event) {
            event.preventDefault();
            
            const clienteNombre = document.getElementById('oferta_cliente_nombre').value;
            const clienteTelefono = document.getElementById('oferta_cliente_telefono').value;
            const tipoOferta = document.getElementById('oferta_tipo').value;
            const mensaje = document.getElementById('oferta_mensaje').value;
            
            // Aqu√≠ se implementar√≠a la l√≥gica para enviar la oferta por WhatsApp
            alert(`Oferta enviada a ${clienteNombre} (${clienteTelefono}) exitosamente.`);
            cerrarModal('modalOferta');
        }
        
        function campanaReactivacion() {
            // Simulamos datos de clientes inactivos
            const clientesInactivos = [
                { id: 1, nombre: 'Cliente #1', telefono: '+53 51234567', dias: 65, total_gastado: 3500 },
                { id: 2, nombre: 'Cliente #2', telefono: '+53 52345678', dias: 85, total_gastado: 2800 },
                { id: 3, nombre: 'Cliente #3', telefono: '+53 53456789', dias: 120, total_gastado: 4200 }
            ];
            
            // Guardar en variable global para usar en filtros
            window.clientesInactivos = clientesInactivos;
            
            // Mostrar todos inicialmente
            mostrarClientesCampana(clientesInactivos);
            
            // Mostrar modal
            mostrarModal('modalCampana');
        }
        
        function filtrarClientesCampana() {
            const filtro = document.getElementById('campana_filtro').value;
            let clientesFiltrados = [];
            
            if (filtro === 'todos') {
                clientesFiltrados = window.clientesInactivos;
            } else if (filtro === '60') {
                clientesFiltrados = window.clientesInactivos.filter(c => c.dias >= 60 && c.dias < 90);
            } else if (filtro === '90') {
                clientesFiltrados = window.clientesInactivos.filter(c => c.dias >= 90);
            } else if (filtro === 'gastado') {
                clientesFiltrados = window.clientesInactivos.filter(c => c.total_gastado > 3000);
            }
            
            mostrarClientesCampana(clientesFiltrados);
        }
        
        function mostrarClientesCampana(clientes) {
            const contenedor = document.getElementById('campana_clientes');
            contenedor.innerHTML = '';
            
            clientes.forEach(cliente => {
                const div = document.createElement('div');
                div.style.padding = '5px';
                div.style.marginBottom = '5px';
                div.style.borderBottom = '1px solid #eee';
                
                div.innerHTML = `
                    <input type="checkbox" value="${cliente.id}" checked> 
                    <strong>${cliente.nombre}</strong> - 
                    ${cliente.telefono} - 
                    Inactivo: ${cliente.dias} d√≠as - 
                    Total: ${cliente.total_gastado} CUP
                `;
                
                contenedor.appendChild(div);
            });
            
            document.getElementById('campana_total').textContent = clientes.length;
        }
        
        function ejecutarCampana() {
            const tipo = document.getElementById('campana_tipo').value;
            const mensaje = document.getElementById('campana_mensaje').value;
            
            // Contar clientes seleccionados
            const checkboxes = document.querySelectorAll('#campana_clientes input[type="checkbox"]:checked');
            const totalSeleccionados = checkboxes.length;
            
            // Aqu√≠ se implementar√≠a la l√≥gica para enviar los mensajes
            alert(`Campa√±a enviada exitosamente a ${totalSeleccionados} clientes.`);
            cerrarModal('modalCampana');
        }
        
        // Cerrar modales al hacer clic fuera
        window.onclick = function(event) {
            document.querySelectorAll('.modal').forEach(modal => {
                if (event.target === modal) {
                    cerrarModal(modal.id);
                }
            });
        }
    </script>
</body>
</html>
